---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

Want to test to see if mortality is different for the different mating styles.
Probably want to check four months because that gives us the biggest sample size.

## Set Up

Load packages

```{r}
library(tidyverse)
```

Load data


```{r}
matingdata_dead <- read.csv("data/matingdatawdead.csv", stringsAsFactors = TRUE, na.strings=c(""))

str(matingdata)
```

Get rid of rows 54 and 55 because they're not relevant. 

```{r}
matingdata_dead_edited <- matingdata_dead[-c(54,55),]

matingdata_dead_edited

```


## Mortality Analysis

#### Figure

Figure of percent mortality by mating, but just at 4 months

```{r}
matingdata_dead_edited %>% 
  filter(treatment == "Recovery C"|treatment=="Recovery G"| treatment == "4 month") %>% 
  drop_na(mating_type) %>% 
  group_by(status, mating_type) %>% 
  summarise(n=n()) %>% 
  ggplot(aes(x=status, y=n, fill=status)) + 
  geom_bar(stat='identity')+
  facet_grid(. ~ mating_type) +
  theme_classic()+
  theme(text = element_text(size = 16), axis.text.x = element_text(size = 16),
        legend.position = "none",
        axis.title.y = element_text(size = 16, margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(size = 16, margin = margin(t = 20, r = 0, b = 0, l = 0)))+
  scale_x_discrete(name="Status")+
  scale_y_continuous(name ="Number of Bees")
```


With all end points

```{r}
matingdata_dead_edited %>% 
  drop_na(mating_type) %>% 
  group_by(status, mating_type) %>% 
  summarise(n=n()) %>% 
  ggplot(aes(x=status, y=n, fill=status)) + 
  geom_bar(stat='identity')+
  facet_grid(. ~ mating_type) +
  theme_classic()+
  theme(text = element_text(size = 16), axis.text.x = element_text(size = 16),
        legend.position = "none",
        axis.title.y = element_text(size = 16, margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(size = 16, margin = margin(t = 20, r = 0, b = 0, l = 0)))+
  scale_x_discrete(name="Status")+
  scale_y_continuous(name ="Number of Bees")
```


#### Sebastien code

```{r}
# Data analysis for the Osmia egg transfer experiment conducted in 2021 by S?bastien Rivest
# The effect on survival probability of aster spines and lupinus alkaloids were investigated...
# independently on 7 species of Osmia as well as their cleptoparasite (Sapyga spp.).

# Set Up
library(coxme)
library(readxl)
library(survival)
library(survminer)

bee_survival <- read_excel("C:/Users/seb69/OneDrive/Documents/Doc/osmia_transfer_2021.xlsx")
# View(bee_survival)

bee_survival$days.to.event<-as.numeric(bee_survival$days.to.event)

# Statistical analyses

# Aster spines
survival_aster <- bee_survival[bee_survival$Experiment == "aster",]
survival_aster$grouping <- paste(survival_aster$Species, survival_aster$Site, survival_aster$Bloc, survival_aster$Hole, sep = "-")

# Model
coxmodelaster <- coxme(Surv(days.to.event, status == 2) ~ treatment*Diet + (1|Species) + (1|Hole/Bloc/Site), data = survival_aster)
summary(coxmodelaster)

# Testing assumptions
modaster<-coxph(Surv(days.to.event, status == 2) ~ treatment*Diet + Species, cluster = grouping, data = survival_aster)
summary(modaster)
cox.zph(modaster)
ggcoxdiagnostics(modaster, type = "schoenfeld")

# Lupine alkaloids
survival_lup <- bee_survival[bee_survival$Experiment == "lup",]
survival_lup$grouping <- paste(survival_lup$Species, survival_lup$Site, survival_lup$Bloc, survival_lup$Hole, sep = "-")
# Putting generalists as reference group.
survival_lup$Diet <- factor(survival_lup$Diet, levels = c("generalist", "cleptoparasite", "fabaceae", "aster"))

# Model
coxmodellup <- coxme(Surv(days.to.event, status == 2) ~ treatment*Diet + (1|Species) + (1|Hole/Bloc/Site), data = survival_lup)
summary(coxmodellup)

# Testing assumptions
modlup<-coxph(Surv(days.to.event, status == 2) ~ treatment*Diet + Species, cluster =grouping, data = survival_lup)
summary(modlup)
cox.zph(modlup)
ggcoxdiagnostics(modlup, type = "schoenfeld")

#######################################
# Individual species plots and analyses
#######################################

# Sapyga, aster
survival_sapyga <- bee_survival[bee_survival$Species == "Sapyga" & bee_survival$Experiment == "aster",]
surv.sap <- survfit(Surv(days.to.event, status == 2) ~ treatment, 
                      data = survival_sapyga)

plot(surv.sap, col=c("gold","darkgoldenrod"), lty=c(1,2),lwd=3,xlab = "Days", ylab = "Proportion living", mark.time=T,mark=4, ylim = c(0, 1.0))

coxmodel <- coxme(Surv(days.to.event, status == 2) ~ treatment + (1|Hole/Bloc/Site), data = survival_sapyga)
summary(coxmodel)

phmodel <- coxph(Surv(days.to.event, status == 2) ~ treatment + Site, cluster =Bloc, data = survival_sapyga)
summary(phmodel)
cox.zph(phmodel)

# Sapyga, lup
survival_sapyga <- bee_survival[bee_survival$Species == "Sapyga" & bee_survival$Experiment == "lup",]
surv.sap <- survfit(Surv(days.to.event, status == 2) ~ treatment, 
                    data = survival_sapyga)

plot(surv.sap, col=c("blue3","cornflowerblue"), lty=c(1,2),lwd=3,xlab = "Days", ylab = "Proportion living", mark.time=T,mark=4, ylim = c(0, 1.0))

# O. iridis, aster
survival_iridis <- bee_survival[bee_survival$Species == "iridis" & bee_survival$Experiment == "aster",]
surv.iri <- survfit(Surv(days.to.event, status == 2) ~ treatment, 
                    data = survival_iridis)

plot(surv.iri, col=c("gold","darkgoldenrod"), lty=c(1,2),lwd=4,xlab = "Days", ylab = "Proportion living", mark.time=T,mark=4, ylim = c(0, 1.0))

coxmodel <- coxme(Surv(days.to.event, status == 2) ~ treatment + (1|Hole/Bloc/Site), data = survival_iridis)
summary(coxmodel)

phmodel <- coxph(Surv(days.to.event, status == 2) ~ treatment + Site, cluster =Bloc, data = survival_iridis)
summary(phmodel)
cox.zph(phmodel)

# O. iridis, lupine
survival_iridis <- bee_survival[bee_survival$Species == "iridis" & bee_survival$Experiment == "lup",]
surv.iri <- survfit(Surv(days.to.event, status == 2) ~ treatment, 
                    data = survival_iridis)

plot(surv.iri, col=c("blue3","cornflowerblue"), lty=c(1,2),lwd=4,xlab = "Days", ylab = "Proportion living", mark.time=T,mark=4, ylim = c(0, 1.0))
ggsurvplot(surv.iri, data = survival_iridis)
coxmodel <- coxme(Surv(days.to.event, status == 2) ~ treatment + (1|Hole/Bloc/Site), data = survival_iridis)
summary(coxmodel)

phmodel <- coxph(Surv(days.to.event, status == 2) ~ treatment + Site, cluster =Bloc, data = survival_iridis)
summary(phmodel)
cox.zph(phmodel)

# O. coloradensis, aster
survival_coloradensis <- bee_survival[bee_survival$Species == "coloradensis" & bee_survival$Experiment == "aster",]
surv.col <- survfit(Surv(days.to.event, status == 2) ~ treatment, 
                    data = survival_coloradensis)

plot(surv.col, col=c("gold","darkgoldenrod"), lty=c(1,2),lwd=4,xlab = "Days", ylab = "Proportion living", mark.time=T,mark=4, ylim = c(0, 1.0))

coxmodel <- coxme(Surv(days.to.event, status == 2) ~ treatment + (1|Hole/Bloc/Site), data = survival_coloradensis)
summary(coxmodel)

phmodel <- coxph(Surv(days.to.event, status == 2) ~ treatment + Site, cluster =Bloc, data = survival_coloradensis)
summary(phmodel)
cox.zph(phmodel)

# O. coloradensis, lupine
survival_coloradensis <- bee_survival[bee_survival$Species == "coloradensis" & bee_survival$Experiment == "lup",]
surv.col <- survfit(Surv(days.to.event, status == 2) ~ treatment, 
                    data = survival_coloradensis)

plot(surv.col, col=c("blue3","cornflowerblue"), lty=c(1,2),lwd=4,xlab = "Days", ylab = "Proportion living", mark.time=T,mark=4, ylim = c(0, 1.0))

# O. lignaria, aster
survival_lignaria <- bee_survival[bee_survival$Species == "lignaria" & bee_survival$Experiment == "aster",]
surv.lig <- survfit(Surv(days.to.event, status == 2) ~ treatment, 
                    data = survival_lignaria)

plot(surv.lig, col=c("gold","darkgoldenrod"), lty=c(1,2),lwd=4,xlab = "Days", ylab = "Proportion living", mark.time=T,mark=4, ylim = c(0, 1.0))

# O. lignaria, lup

survival_lignaria <- bee_survival[bee_survival$Species == "lignaria" & bee_survival$Experiment == "lup",]
surv.lig <- survfit(Surv(days.to.event, status == 2) ~ treatment, 
                    data = survival_lignaria)

plot(surv.lig, col=c("blue3","cornflowerblue"), lty=c(1,2),lwd=4,xlab = "Days", ylab = "Proportion living", mark.time=T,mark=4, ylim = c(0, 1.0))

# O. montana, lup
survival_montana <- bee_survival[bee_survival$Species == "montana" & bee_survival$Experiment == "lup",]
surv.mon <- survfit(Surv(days.to.event, status == 2) ~ treatment, 
                    data = survival_montana)

plot(surv.mon, col=c("blue3","cornflowerblue"), lty=c(1,2),lwd=3,xlab = "Days", ylab = "Proportion living", mark.time=T,mark=4, ylim = c(0, 1.0))
coxmodel <- coxme(Surv(days.to.event, status == 2) ~ treatment + (1|Hole/Bloc/Site), data = survival_montana)
summary(coxmodel)

# O. tersula, lup
survival_tersula <- bee_survival[bee_survival$Species == "tersula" & bee_survival$Experiment == "lup",]
surv.ter <- survfit(Surv(days.to.event, status == 2) ~ treatment, 
                    data = survival_tersula)

plot(surv.ter, col=c("blue3","cornflowerblue"), lty=c(1,2),lwd=4,xlab = "Days", ylab = "Proportion living", mark.time=T,mark=4, ylim = c(0, 1.0))

phmodel <- coxph(Surv(days.to.event, status == 2) ~ treatment + Site, cluster =Bloc, data = survival_tersula)
summary(phmodel)
cox.zph(phmodel)

# O. subaustralis, lup
survival_subaustralis <- bee_survival[bee_survival$Species == "subaustralis" & bee_survival$Experiment == "lup",]
surv.sub <- survfit(Surv(days.to.event, status == 2) ~ treatment, 
                    data = survival_subaustralis)

plot(surv.sub, col=c("blue3","cornflowerblue"), lty=c(1,2),lwd=4,xlab = "Days", ylab = "Proportion living", mark.time=T,mark=4, ylim = c(0, 1.0))

# O. subaustralis, aster
survival_subaustralis <- bee_survival[bee_survival$Species == "subaustralis" & bee_survival$Experiment == "aster",]
surv.sub <- survfit(Surv(days.to.event, status == 2) ~ treatment, 
                    data = survival_subaustralis)

plot(surv.sub, col=c("gold","darkgoldenrod"), lty=c(1,2),lwd=4,xlab = "Days", ylab = "Proportion living", mark.time=T,mark=4, ylim = c(0, 1.0))

# O. tristella, aster
survival_tristella <- bee_survival[bee_survival$Species == "tristella" & bee_survival$Experiment == "aster",]
surv.tris <- survfit(Surv(days.to.event, status == 2) ~ treatment, 
                    data = survival_tristella)

plot(surv.tris, col=c("gold","darkgoldenrod"), lty=c(1,2),lwd=4,xlab = "Days", ylab = "Proportion living", mark.time=T,mark=4, ylim = c(0, 1.0))

# O. tristella, lup
survival_tristella <- bee_survival[bee_survival$Species == "tristella" & bee_survival$Experiment == "lup",]
surv.tris <- survfit(Surv(days.to.event, status == 2) ~ treatment, 
                     data = survival_tristella)

plot(surv.tris, col=c("blue3","cornflowerblue"), lty=c(1,2),lwd=4,xlab = "Days", ylab = "Proportion living", mark.time=T,mark=4, ylim = c(0, 1.0))


survival_montana <- bee_survival[bee_survival$Species == "montana" & bee_survival$Experiment == "aster",]
surv.mon <- survfit(Surv(days.to.event, status == 2) ~ treatment, 
                    data = survival_montana)

plot(surv.mon, col=c("gold","darkgoldenrod"), lty=c(1,2),lwd=3,xlab = "Days", ylab = "Proportion living", mark.time=T,mark=4, ylim = c(0, 1.0))
coxmodel <- coxme(Surv(days.to.event, status == 2) ~ treatment + (1|Hole/Bloc/Site), data = survival_montana)
summary(coxmodel)

coxmodel <- coxme(Surv(days.to.event, status == 2) ~ treatment + Species + (1|Hole/Bloc/Site), data = bee_survival)
summary(coxmodel)


# Statistical analyses garbage bin

# Aster
survival_aster <- bee_survival[bee_survival$Experiment == "aster",]
survival_aster$species_treat <- survival_aster$treatment * survival_aster$Species
coxmodel <- coxme(Surv(days.to.event, status == 2) ~ + treatment * Species  + (1|Hole/Bloc/Site), data = survival_aster)
summary(coxmodel)


survival_aster <- bee_survival[bee_survival$Experiment == "aster",]
survival_aster$grouping <- paste(survival_aster$Species, survival_aster$Site, survival_aster$Bloc, survival_aster$Hole, sep = "-")

mod<-coxph(Surv(days.to.event, status == 2) ~ treatment*Species, cluster =grouping, data = survival_aster)
summary(mod)
cox.zph(mod)

mod<-coxph(Surv(days.to.event, status == 2) ~ treatment*Diet + Species, cluster =grouping, data = survival_aster)
summary(mod)
plot(cox.zph(mod),var=2)
cox.zph(mod)
ggcoxdiagnostics(mod, type = "schoenfeld")

glht(mod, mcp(treatment*Species = "Tukey"))

survival_lup <- bee_survival[bee_survival$Experiment == "lup",]

survival_lup$grouping <- paste(survival_lup$Species, survival_lup$Site, survival_lup$Bloc, survival_lup$Hole, sep = "-")
survival_lup$Diet <- factor(survival_lup$Diet, levels = c("generalist", "cleptoparasite", "fabaceae", "aster"))

mod<-coxph(Surv(days.to.event, status == 2) ~ treatment*Species, cluster =grouping, data = survival_lup)
summary(mod)
cox.zph(mod)

coxmodel <- coxme(Surv(days.to.event, status == 2) ~ treatment*Diet + (1|Species) + (1|Hole/Bloc/Site), data = survival_aster)
summary(coxmodel)

coxmodel <- coxme(Surv(days.to.event, status == 2) ~ treatment*Diet + (1|Species) + (1|Hole/Bloc/Site), data = survival_lup)
summary(coxmodel)

mod<-coxph(Surv(days.to.event, status == 2) ~ treatment*Diet + Species, cluster =grouping, data = survival_lup)
summary(mod)
cox.zph(mod)
```


#### Analysis

Output is binary, I need to do survival analysis. This is Jessica's wheelhouse, so I should ask her.

The basic structure that I want though is:

*mortality ~ mating_behaviour + day_0_weight*

We're just going to try a linear model with a binomial distribution, but only using mon

```{r}
mortmodel1 <- lm(status ~ mating_type + day_0_weight, data=matingdata_dead_edited, family = binomial)

summary(mortmodel1)
```


This doesn't work, TO GOOGLE!

So apparently when your dependent variable is a dichotomous outcome (i.e., alive/dead) and you have 2+ independent variables, you want to use **multiple logistic regression**


Using code from https://rcompanion.org/rcompanion/e_07.html, assumptions from http://www.biostathandbook.com/multiplelogistic.html

Our variables have to be made numeric for this to work. Start by making a smaller data set of just the variables that we want.

```{r}
matingdata_dead_num <- matingdata_dead_edited %>% 
  select(day_0_weight, day_10_weight, mating_type, prehib_weightdiff, status)

str(matingdata_dead_num)
```

Then make everything numeric

```{r}
matingdata_dead_num$mating_type_num <- as.numeric(matingdata_dead_num$mating_type)
#1 = dorsal, 2 = none, 3 = spasm

matingdata_dead_num$status_num <- as.numeric(matingdata_dead_num$status)
#1 = alive, 2 = dead

#change the 1 and 2 for alive and dead to be 1 and 0

matingdata_dead_num$status_num <-
  replace(matingdata_dead_num$status_num,matingdata_dead_num$status_num == 2,0)

#use str to double check that variables are coded properly
str(matingdata_dead_num)
```

Remove the factors for the correlation analysis

```{r}
md_dead_num_nofac <- matingdata_dead_num[-c(3,5)]
str(md_dead_num_nofac)
```


Examine correlation among variables

```{r}
install.packages("PerformanceAnalytics")
library(PerformanceAnalytics)

chart.Correlation(md_dead_num_nofac, method = "spearman", histogram = TRUE)
```

Test the model using glm

```{r}
mortmodel2 <- glm(status_num ~ mating_type_num + day_0_weight, data = md_dead_num_nofac, family= binomial)


summary(mortmodel2)

#Deviance Residuals: 
#    Min       1Q   Median       3Q      Max  
#-2.3111  -0.8469   0.5000   0.8082   1.5926  

#Coefficients:
#                 Estimate Std. Error z value #Pr(>|z|)   
#(Intercept)     -5.454137   1.828571  -2.983  0.00286 **
#mating_type_num  0.909879   0.632900   1.438  0.15054   
#day_0_weight     0.007881   0.002569   3.067  0.00216 **
#---
#Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

#(Dispersion parameter for binomial family taken to be 1)

#    Null deviance: 70.252  on 52  degrees of freedom
#Residual deviance: 55.545  on 50  degrees of freedom
#AIC: 61.545

#Number of Fisher Scoring iterations: 5
```

Plot residuals

```{r}
plot(fitted(mortmodel2),
     rstandard(mortmodel2))
```

Check for overdispersion

Overdispersion is a situation where the residual deviance of the glm is large relative to the residual degrees of freedom. 
One guideline is that if the ratio of the residual deviance to the residual degrees of freedom exceeds 1.5, then the model is overdispersed. 

```{r}
summary(mortmodel2)$deviance / summary(mortmodel2)$df.residual

#1.11, close but not over 1.5!
```


## Another mortality model but with pre-hib weight difference as explanatory

```{r}
mortmodel3 <- glm(status_num ~ mating_type_num + day_0_weight + prehib_weightdiff, data = md_dead_num_nofac, family= binomial)

summary(mortmodel3)
```

Everything is non significant, basically if you start big you survive hibernation, congrats to you. 



